function getAnimatorSelfInstance(currentThis){var self=void 0;return self=void 0!=currentThis.animator?currentThis.animator:currentThis}function Animator(){var self=getAnimatorSelfInstance(this);self._setupCanvas(),stage.addEventListener("stagemousedown",self._mouseDownHandler),self.NODE_RADIUS=25,self.TOPOLOGY_RADIUS=Math.min(self._canvas.width,self._canvas.height)/2-2*self.NODE_RADIUS,self.REDRAW_FREQUENCY=1e3,self.TOPOLOGY_CENTER_X=self._canvas.width/2,self.TOPOLOGY_CENTER_Y=self._canvas.height/2,self.TOPOLOGY_WIDTH=self._canvas.width,self.TOPOLOGY_HEIGHT=self._canvas.height,self._protocolColors={arp:"blue",ipv4:"red",ipv6:"green"},self._nodes={},self._networkFilterV4=ipaddr.parseCIDR("0.0.0.0/0"),self._showIPv4=!0,self._networkFilterV6=ipaddr.parseCIDR("0::0/0"),self._showIPv6=!0,self._redrawInterval=0,self._canvasZoom=0,createjs.Ticker.setFPS(60),createjs.Ticker.addEventListener("tick",stage),self._drawRouter(),self._redrawInterval>0&&clearInterval(self._redrawInterval),self._redrawInterval=setInterval(self._redrawNodes,self.REDRAW_FREQUENCY)}function addMessageToDOM(traffic){var trafficFeed=$("#trafficFeed");trafficFeed.prepend('<p class="trafficMessage">'+traffic+"</p>"),trafficFeed[0].childElementCount>10&&trafficFeed.html(trafficFeed.children().slice(0,10))}function Interface(){var self=this;self._name="",self._ipList=[]}function showError(message){$("#error-message").html(message),$(".error-modal").modal()}$(function(){$.ajax({url:"/templates/error-modal.html",success:function(data){$("#error-modal-container").html(data)},dataType:"html"})});var stage=new createjs.Stage("trafficCanvas");Animator.prototype.addNode=function(ip){var self=getAnimatorSelfInstance(this),ipObj=ipaddr.parse(ip),filter=self._networkFilterV4,showNode="ipv6"===ipObj.kind()?self._showIPv6:self._showIPv4;"ipv6"===ipObj.kind()&&(filter=self._networkFilterV6),ip in self._nodes||!ipaddr.parse(ip).match(filter)||!showNode||(self._nodes[ip]={graphic:self._createNodeGraphic(ip),x:0,y:0},stage.addChild(self._nodes[ip].graphic),self._redrawNodes())},Animator.prototype.removeAllNodes=function(){var self=getAnimatorSelfInstance(this);for(var ip in self._nodes)stage.removeChild(self._nodes[ip].graphic),delete self._nodes[ip]},Animator.prototype.setNetworkFilterV4=function(newFilter){var self=getAnimatorSelfInstance(this);newFilter?self._networkFilterV4=newFilter:self._networkFilterV4=ipaddr.parseCIDR("0.0.0.0/0"),self._resetNodeView()},Animator.prototype.resetNetworkFilterV4=function(){var self=getAnimatorSelfInstance(this);self._networkFilterV4=ipaddr.parseCIDR("0.0.0.0/0"),self._resetNodeView()},Animator.prototype.setIPv4Visibility=function(bool){var self=getAnimatorSelfInstance(this);self._showIPv4=bool,self._resetNodeView()},Animator.prototype.setNetworkFilterV6=function(newFilter){var self=getAnimatorSelfInstance(this);newFilter?self._networkFilterV6=newFilter:self._networkFilterV6=ipaddr.parseCIDR("0::0/0"),self._resetNodeView()},Animator.prototype.resetNetworkFilterV6=function(){var self=getAnimatorSelfInstance(this);self._networkFilterV6=ipaddr.parseCIDR("0::0/0"),self._resetNodeView()},Animator.prototype.setIPv6Visibility=function(bool){var self=getAnimatorSelfInstance(this);self._showIPv6=bool,self._resetNodeView()},Animator.prototype.addTraffic=function(sourceAddr,destAddr,type){var self=getAnimatorSelfInstance(this),result=!1,destIP=ipaddr.parse(destAddr);try{var cidrRange=self._isMulticast(destAddr);if(-1==cidrRange||"ipv4"!=type&&"ipv6"!=type)self.displayTraffic(sourceAddr,destAddr,type);else for(var ip in self._nodes){var checkedIP=ipaddr.parse(ip);checkedIP.kind()==destIP.kind()&&checkedIP.match(destIP,cidrRange)&&self.displayTraffic(sourceAddr,ip,type)}result=!0}catch(e){console.log("Error adding traffic: ",e)}finally{return result}},Animator.prototype.displayTraffic=function(sourceAddr,destAddr,type){var self=getAnimatorSelfInstance(this),originX=0,originY=0,destX=0,destY=0,result=!1;try{var sourceNode=self._nodes[sourceAddr],destNode=self._nodes[destAddr];sourceNode&&sourceNode.graphic?(originX=sourceNode.x,originY=sourceNode.y):(originX=self.TOPOLOGY_CENTER_X,originY=self.TOPOLOGY_CENTER_Y),destNode&&destNode.graphic?(destX=destNode.x,destY=destNode.y):(destX=self.TOPOLOGY_CENTER_X,destY=self.TOPOLOGY_CENTER_Y);var rotation=self._getTrafficRotation(originX,destX,originY,destY),beamHeight=3,beam=new createjs.Shape;beam.graphics.beginFill(self._protocolColors[type]),beam.graphics.moveTo(0,1.5).lineTo(70,0).lineTo(70,beamHeight).closePath(),beam.x=originX,beam.y=originY,beam.regX=0,beam.regY=1.5,beam.rotation=rotation;var height=10,width=self._calculateDistanceBetweenPoints(originX,originY,destX,destY),graphics=(new createjs.Graphics).drawRect(0,0,width,height),mask=new createjs.Shape(graphics);mask.x=originX,mask.y=originY,mask.regX=0,mask.regY=5,mask.rotation=rotation,beam.mask=mask,stage.addChildAt(beam,0),createjs.Tween.get(beam,{loop:!1,onChange:self._beamUpdate}).to({x:destX,y:destY,alpha:1},1500,createjs.Ease.linear).call(self._beamComplete),result=!0}catch(e){console.log("Error displaying traffic: ",e)}finally{return result}},Animator.prototype._beamUpdate=function(e){},Animator.prototype._beamComplete=function(e){var beam=(getAnimatorSelfInstance(this),e.target);stage.removeChild(beam.mask),stage.removeChild(beam),createjs.Tween.removeTweens(e)},Animator.prototype._createNodeGraphic=function(ip){var self=getAnimatorSelfInstance(this),circle=new createjs.Shape;circle.graphics.beginFill("DeepSkyBlue").drawCircle(0,0,self.NODE_RADIUS);var text=new createjs.Text(ip,"10px Times New Roman","#000");text.x=0,text.y=self.NODE_RADIUS+5,text.textAlign="center";var container=new createjs.Container;return container.addChild(circle),container.addChild(text),container},Animator.prototype._findSlope=function(x1,x2,y1,y2){return x1==x2?0:(y2-y1)/(x2-x1)},Animator.prototype._slopeToDegrees=function(slope){return Math.atan(slope)*(180/Math.PI)},Animator.prototype._calculateDistanceBetweenPoints=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x2-x1,2)+Math.pow(y2-y1,2))},Animator.prototype._redrawNodes=function(){var self=getAnimatorSelfInstance(this),totalNodes=Object.keys(self._nodes).length,current=0,step=2*Math.PI/totalNodes;for(var ip in self._nodes){var newX=self.TOPOLOGY_CENTER_X+self.TOPOLOGY_RADIUS*Math.cos(current),newY=self.TOPOLOGY_CENTER_Y+self.TOPOLOGY_RADIUS*Math.sin(current);createjs.Tween.get(self._nodes[ip].graphic,{loop:!1}).to({x:newX,y:newY},500,createjs.Ease.linear),self._nodes[ip].x=newX,self._nodes[ip].y=newY,current+=step}},Animator.prototype._drawRouter=function(){var self=getAnimatorSelfInstance(this),router=new createjs.Shape;router.graphics.beginFill("Black").drawCircle(self.TOPOLOGY_CENTER_X,self.TOPOLOGY_CENTER_Y,12),stage.addChild(router)},Animator.prototype._getTrafficRotation=function(originX,destX,originY,destY){var self=getAnimatorSelfInstance(this),rotation=self._slopeToDegrees(self._findSlope(originX,destX,originY,destY));return originX>destX?rotation+=180:destX==originX&&(originY>destY?rotation-=90:rotation+=90),rotation},Animator.prototype._resetNodeView=function(){socket.emit("nodeListRequest")},Animator.prototype._setupCanvas=function(){var self=getAnimatorSelfInstance(this);self._canvas=document.getElementById("trafficCanvas");var navbarDimensions=document.getElementsByClassName("navbar")[0].getBoundingClientRect(),footerDimensions=document.getElementsByTagName("footer")[0].getBoundingClientRect();self._canvas.width=document.body.clientWidth,self._canvas.height=document.body.clientHeight-footerDimensions.height-navbarDimensions.height,self._canvas.addEventListener("mousewheel",self._mouseWheelHandler,!1),self._canvas.addEventListener("DOMMouseScroll",self._mouseWheelHandler,!1)},Animator.prototype._mouseWheelHandler=function(e){var self=getAnimatorSelfInstance(this);Math.max(-1,Math.min(1,e.wheelDelta||-e.detail))>0?self._zoom=1.1:self._zoom=1/1.1;var local=stage.globalToLocal(stage.mouseX,stage.mouseY);stage.regX=local.x,stage.regY=local.y,stage.x=stage.mouseX,stage.y=stage.mouseY,stage.scaleX=stage.scaleY*=self._zoom,stage.update()},Animator.prototype._mouseDownHandler=function(e){var offset={x:stage.x-e.stageX,y:stage.y-e.stageY};stage.addEventListener("stagemousemove",function(ev){stage.x=ev.stageX+offset.x,stage.y=ev.stageY+offset.y,stage.update()}),stage.addEventListener("stagemouseup",function(){stage.removeAllEventListeners("stagemousemove")})},Animator.prototype._isMulticast=function(address){var ip=ipaddr.parse(address),lastOctetWasBroadcast=!1,result=0;try{if("ipv6"==ip.kind())result="multicast"==ip.range()?16:-1;else{var octets=ip.octets;for(i=0;i<octets.length;i++)255==octets[i]?(lastOctetWasBroadcast||(result=8*i),lastOctetWasBroadcast=!0):(result=-1,lastOctetWasBroadcast=!1)}}catch(e){console.log(e)}finally{return result}},$(function(){socket.on("connect",function(){socket.emit("nodeListRequest")}),socket.on("reconnect",function(){socket.emit("nodeListRequest")}),socket.on("system",function(data){addMessageToDOM(data.msg)}),socket.on("traffic",function(data){var result=animator.addTraffic(data.addresses[0],data.addresses[1],data.type);result&&(addMessageToDOM(data.type+" - "+data.msg),data.serviceName&&NetworkStatistics.addServiceCount(data.serviceName,data.port))}),socket.on("newNode",function(data){animator.addNode(data.ip)}),socket.on("nodeList",function(data){animator.removeAllNodes();for(var i=0;i<data.list.length;i++)animator.addNode(data.list[i])}),socket.on("error",function(data){showError(data.error)})}),$(function(){var $startButton=$("#startCapture"),$stopButton=$("#stopCapture"),$ipv4Toggle=$("#ipv4-toggle"),$networkFilterV4=$("#networkFilterV4"),$networkFilterClearV4=$("#networkFilterClearV4"),$ipv6Toggle=$("#ipv6-toggle"),$networkFilterV6=$("#networkFilterV6"),$networkFilterClearV6=$("#networkFilterClearV6");$startButton.click(function(e){socket.emit("startCapture")}),$stopButton.click(function(e){socket.emit("stopCapture")}),$ipv4Toggle.change(function(){animator.setIPv4Visibility($(this).prop("checked"))}),$ipv6Toggle.change(function(){animator.setIPv6Visibility($(this).prop("checked"))}),$networkFilterClearV4.click(function(e){animator.resetNetworkFilterV4(),$networkFilterV4.val("")}),$networkFilterClearV6.click(function(e){animator.resetNetworkFilterV6(),$networkFilterV6.val("")}),$networkFilterV4.keydown(function(event){if(!event)var event=window.event;if(13==event.which){event.preventDefault();var networkFilterInput=$networkFilterV4.val(),filter=void 0;try{networkFilterInput?(filter=ipaddr.IPv4.parseCIDR($networkFilterV4.val()),animator.setNetworkFilterV4(filter)):animator.resetNetworkFilterV4()}catch(e){showError(e)}finally{$networkFilterV4.blur()}}}),$networkFilterV6.keydown(function(event){if(!event)var event=window.event;if(13==event.which){event.preventDefault();var networkFilterInput=$networkFilterV6.val(),filter=void 0;try{networkFilterInput?(filter=ipaddr.IPv6.parseCIDR($networkFilterV6.val()),animator.setNetworkFilterV6(filter)):animator.resetNetworkFilterV6()}catch(e){showError(e)}finally{$networkFilterV6.blur()}}})});var NetworkStatistics=function(){var _serviceTrackingMap=[],updateDOMProtocolInfo=function(){_serviceTrackingMap.sort(function(a,b){return b.count-a.count});for(var i=Math.min(5,_serviceTrackingMap.length);i--;)$("#service"+i).html("<strong>"+_serviceTrackingMap[i].serviceName+"</strong>"),$("#count"+i).html("<strong>"+_serviceTrackingMap[i].count+"</strong>"),$("#port"+i).html("<strong>"+_serviceTrackingMap[i].port+"</strong>")};return{addServiceCount:function(serviceName,port){for(var element=void 0,i=_serviceTrackingMap.length;i--;)if(_serviceTrackingMap[i].port===port){element=_serviceTrackingMap[i];break}"undefined"==typeof element?_serviceTrackingMap.push({serviceName:serviceName,count:1,port:port}):element.count++,updateDOMProtocolInfo()}}}(),currentInterface=new Interface;Interface.prototype.getName=function(){return this._name},Interface.prototype.setName=function(name){this._name=name},Interface.prototype.getAddressData=function(){return this._ipList},Interface.prototype.addAddressData=function(ip,netmask){this._ipList.push([ip,netmask])},Interface.prototype.clearAddressData=function(){this._ipList=[]},$(function(){function updateCurrentInterface(interfaceName){$(".current-interface").each(function(){$(this).html(interfaceName)})}function reposition(){var modal=$(this),dialog=modal.find(".modal-dialog");modal.css("display","block"),dialog.css("margin-top",Math.max(0,($(window).height()-dialog.height())/2))}var $applyInterfaceSettingsButton=$("#apply-interface-settings");socket.emit("getInterfaceSettings"),socket.emit("interfaceListRequest"),socket.on("monitorModeChanged",function(data){0==data.enabled&&(showError("An error occurred enabling monitor mode for this device."),$("#monitor-toggle").prop("checked",!1))}),socket.on("interfaceSettings",function(data){currentInterface.setName(data.name),currentInterface.clearAddressData();for(var i=0;i<data.address.length;i++)currentInterface.addAddressData(data.address[i][0],data.address[i][1]);updateCurrentInterface(currentInterface.getName())}),socket.on("interfaceList",function(data){var element=$("#interface-radio-group"),html="";html+='<div class="row">';for(var i=0;i<data.list.length;i++){var checked=1==data.list[i].selected?"checked":"";html+='        <div class="col-xs-4">          <label class="radio-inline">            <input type="radio" name="interface-radio"               value="'+data.list[i].name+'" '+checked+">"+data.list[i].name+"</input>          </label>        </div>",i%3==2&&(html+="</div>",html+='<div class="row">')}html+="</div>",element.html(html)}),$("#monitor-toggle").change(function(e){socket.emit("enableMonitorMode",{enable:$("#monitor-toggle").prop("checked")})}),$applyInterfaceSettingsButton.click(function(e){socket.emit("updateCurrentInterface",{name:$("input:radio[name='interface-radio']:checked").val()}),$("#monitor-toggle").prop("checked")&&socket.emit("enableMonitorMode"),$("#network-interface-modal").modal("hide")}),$(".modal").on("show.bs.modal",reposition),$(window).on("resize",function(){$(".modal:visible").each(reposition)})});var app=app||{},socket=io.connect(),animator=new Animator;