function getAnimatorSelfInstance(currentThis){var self=void 0;return self=void 0!=currentThis.animator?currentThis.animator:currentThis}function Animator(){var self=getAnimatorSelfInstance(this);self._setupCanvas(),stage.addEventListener("stagemousedown",self._mouseDownHandler),self.NODE_RADIUS=25,self.TOPOLOGY_RADIUS=Math.min(self._canvas.width,self._canvas.height)/2-2*self.NODE_RADIUS,self.REDRAW_FREQUENCY=1e3,self.TOPOLOGY_CENTER_X=self._canvas.width/2,self.TOPOLOGY_CENTER_Y=self._canvas.height/2,self.TOPOLOGY_WIDTH=self._canvas.width,self.TOPOLOGY_HEIGHT=self._canvas.height,self._protocolColors={arp:"blue",ipv4:"red",ipv6:"green"},self._nodes={},self._redrawInterval=0,self._canvasZoom=0,createjs.Ticker.setFPS(60),createjs.Ticker.addEventListener("tick",stage),self._drawRouter(),self._redrawInterval>0&&clearInterval(self._redrawInterval),self._redrawInterval=setInterval(self._redrawNodes,self.REDRAW_FREQUENCY)}function addMessageToDOM(traffic){var trafficFeed=$("#trafficFeed");trafficFeed.prepend('<p class="trafficMessage">'+traffic+"</p>"),trafficFeed[0].childElementCount>10&&trafficFeed.html(trafficFeed.children().slice(0,10))}function showError(message){$("#error-message").html(message),$(".error-modal").modal()}$(function(){$("#error-modal-container").load("/templates/error-modal.html")});var stage=new createjs.Stage("trafficCanvas");Animator.prototype.addNode=function(ip){var self=getAnimatorSelfInstance(this);ip in self._nodes||(self._nodes[ip]={graphic:self._createNodeGraphic(ip),x:0,y:0},stage.addChild(self._nodes[ip].graphic),self._redrawNodes())},Animator.prototype.removeAllNodes=function(){var self=getAnimatorSelfInstance(this);for(var ip in self._nodes)stage.removeChild(self._nodes[ip].graphic),delete self._nodes[ip]},Animator.prototype.displayTraffic=function(sourceAddr,destAddr,type){var self=getAnimatorSelfInstance(this),originX=0,originY=0,destX=0,destY=0,result=!1;try{var sourceNode=self._nodes[sourceAddr],destNode=self._nodes[destAddr];sourceNode?(originX=sourceNode.x,originY=sourceNode.y):(originX=self.TOPOLOGY_CENTER_X,originY=self.TOPOLOGY_CENTER_Y),destNode?(destX=destNode.x,destY=destNode.y):(destX=self.TOPOLOGY_CENTER_X,destY=self.TOPOLOGY_CENTER_Y);var beam=new createjs.Shape;beam.graphics.beginFill(self._protocolColors[type]),beam.graphics.moveTo(0,1.5).lineTo(70,0).lineTo(70,3).closePath(),beam.x=originX,beam.y=originY,beam.setBounds(0,0,70,3),beam.rotation=self._getTrafficRotation(originX,destX,originY,destY);var mask=new createjs.Shape;mask.graphics.s("#f00").moveTo(originX,originY).lineTo(originX,originY+10).lineTo(destX,destY+10).lineTo(destX,destY-10).lineTo(originX,originY-10).closePath(),beam.mask=mask,stage.addChildAt(beam,0),createjs.Tween.get(beam,{loop:!1,onChange:self._beamUpdate}).to({x:destX,y:destY,alpha:1},1500,createjs.Ease.linear).call(self._beamComplete),result=!0}catch(e){console.log("Error displaying traffic: ",e)}finally{return result}},Animator.prototype._beamUpdate=function(e){},Animator.prototype._beamComplete=function(e){var beam=(getAnimatorSelfInstance(this),e.target);stage.removeChild(beam.mask),stage.removeChild(beam),createjs.Tween.removeTweens(e)},Animator.prototype._createNodeGraphic=function(ip){var self=getAnimatorSelfInstance(this),circle=new createjs.Shape;circle.graphics.beginFill("DeepSkyBlue").drawCircle(0,0,self.NODE_RADIUS);var text=new createjs.Text(ip,"10px Times New Roman","#000");text.x=0,text.y=self.NODE_RADIUS+5,text.textAlign="center";var container=new createjs.Container;return container.addChild(circle),container.addChild(text),container},Animator.prototype._findSlope=function(x1,x2,y1,y2){return x1==x2?0:(y2-y1)/(x2-x1)},Animator.prototype._slopeToDegrees=function(slope){return Math.atan(slope)*(180/Math.PI)},Animator.prototype._redrawNodes=function(){var self=getAnimatorSelfInstance(this),totalNodes=Object.keys(self._nodes).length,current=0,step=2*Math.PI/totalNodes;for(var ip in self._nodes){var newX=self.TOPOLOGY_CENTER_X+self.TOPOLOGY_RADIUS*Math.cos(current),newY=self.TOPOLOGY_CENTER_Y+self.TOPOLOGY_RADIUS*Math.sin(current);createjs.Tween.get(self._nodes[ip].graphic,{loop:!1}).to({x:newX,y:newY},500,createjs.Ease.linear),self._nodes[ip].x=newX,self._nodes[ip].y=newY,current+=step}},Animator.prototype._drawRouter=function(){var self=getAnimatorSelfInstance(this),router=new createjs.Shape;router.graphics.beginFill("Black").drawCircle(self.TOPOLOGY_CENTER_X,self.TOPOLOGY_CENTER_Y,12),stage.addChild(router)},Animator.prototype._getTrafficRotation=function(originX,destX,originY,destY){var self=getAnimatorSelfInstance(this),rotation=self._slopeToDegrees(self._findSlope(originX,destX,originY,destY));return originX>destX?rotation+=180:destX==originX&&(originY>destY?rotation-=90:rotation+=90),rotation},Animator.prototype._setupCanvas=function(){var self=getAnimatorSelfInstance(this);self._canvas=document.getElementById("trafficCanvas");var navbarDimensions=document.getElementsByClassName("navbar")[0].getBoundingClientRect(),footerDimensions=document.getElementsByTagName("footer")[0].getBoundingClientRect();self._canvas.width=document.body.clientWidth,self._canvas.height=document.body.clientHeight-footerDimensions.height-navbarDimensions.height,self._canvas.addEventListener("mousewheel",self._mouseWheelHandler,!1),self._canvas.addEventListener("DOMMouseScroll",self._mouseWheelHandler,!1)},Animator.prototype._mouseWheelHandler=function(e){var self=getAnimatorSelfInstance(this);Math.max(-1,Math.min(1,e.wheelDelta||-e.detail))>0?self._zoom=1.1:self._zoom=1/1.1;var local=stage.globalToLocal(stage.mouseX,stage.mouseY);stage.regX=local.x,stage.regY=local.y,stage.x=stage.mouseX,stage.y=stage.mouseY,stage.scaleX=stage.scaleY*=self._zoom,stage.update()},Animator.prototype._mouseDownHandler=function(e){var offset={x:stage.x-e.stageX,y:stage.y-e.stageY};stage.addEventListener("stagemousemove",function(ev){stage.x=ev.stageX+offset.x,stage.y=ev.stageY+offset.y,stage.update()}),stage.addEventListener("stagemouseup",function(){stage.removeAllEventListeners("stagemousemove")})},$(function(){socket.on("connect",function(){socket.emit("nodeListRequest")}),socket.on("reconnect",function(){socket.emit("nodeListRequest")}),socket.on("system",function(data){addMessageToDOM(data.msg)}),socket.on("traffic",function(data){var result=animator.displayTraffic(data.traffic[0],data.traffic[1],data.type);result&&addMessageToDOM(data.type+"."+result.toString()+": "+data.msg)}),socket.on("newNode",function(data){animator.addNode(data.ip)}),socket.on("nodeList",function(data){animator.removeAllNodes();for(var i=0;i<data.list.length;i++)animator.addNode(data.list[i])}),socket.on("error",function(data){showError(data.error)})});var app=app||{},socket=io.connect(),animator=new Animator;$(function(){var $startButton=($("#trafficFeed"),$("#startCapture")),$stopButton=$("#stopCapture");$startButton.click(function(e){socket.emit("startCapture")}),$stopButton.click(function(e){socket.emit("stopCapture")})});